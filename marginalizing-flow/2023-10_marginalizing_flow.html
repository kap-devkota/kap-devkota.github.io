<!DOCTYPE html>
<html>
<head>
    <title> Flow matching for generative modelling </title>
    <script src= "https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
    window.MathJax = {
        tex: {
        tags: 'ams',
        inlineMath: [['$', '$'], ['\\(', '\\)']], // enable $...$ for inline
        displayMath: [['$$', '$$'], ['\\[', '\\]']] // block math
        },
        options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    };
    </script>

    <style>
        body {
            counter-reset: heading;
        } 

        h2:before {
            counter-increment: heading;
            content: counter(heading) " ";
            counter-reset: subheading;
        }

        h3:before {
            content: counter(heading) "." counter(subheading) " ";
            counter-increment: subheading;
        }
    </style>

    <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
    </script>
</head>
<body>
<h2>Theorem 1 (Continuity equations).</h2>

Eq 24:
\begin{align} 
 \partial_{\alpha_k} \int_{\mathbb{R}^d} \phi(x) p(\alpha, x) dx &= \int_{\Omega} \partial_{\alpha_k} (\phi(x(\alpha)) p(x_0,\ldots, x_K)) d\mathbf{x} \\
 &= \int_{\Omega}p(x_1, \ldots, x_K) p(x_0) 
            \partial_{\alpha_k}\phi(x(\alpha))  d\mathbf{x} \\ 
 &= \int_{\Omega}p(x_1, \ldots, x_K) p(x_0) 
             (\nabla \phi)\left(\sum_i^K x_i \alpha_i\right) \cdot x_k d\mathbf{x}\\
 &= \mathbb{E}\left[x_k \cdot \nabla \phi(x(\alpha))\right]   
\end{align}

Eq 28:
\begin{align}

\mathbb{E}\left[x_0^{(j)} e^{i \alpha_0 k \cdot x_0 } \right] &= - 
i\alpha_0^{-1} \partial_{k_j} \left(\mathbb{E}\left[e^{i\alpha_0k \cdot x_0} \right]\right) \label{eq:5}\\
\mathbb{E}\left[x_0 e^{i \alpha_0 k \cdot x_0 }\right] &=  i\alpha_0^{-1} \nabla_k \left(\mathbb{E}\left[e^{i\alpha_0k \cdot x_0} \right]\right) = i\alpha_0e^{-\alpha_0^2|k|^2/2}k \\

\therefore \mathbb{E}\left[x_0 e^{i k \cdot x(\alpha)} \right] &= i \alpha_0 k \mathbb{E}\left[e^{ik\cdot x(\alpha)}\right]
\\
\text{Similarly,} & \nonumber\\
\mathbb{E}_{\mathbf{x}}\left[x_p \exp^{i k \cdot \sum_i \alpha_i x_i } \right] &= \int_{\Omega} 
    x_p \exp^{ik \cdot \sum_i \alpha_i x_i} p(x_0, \ldots, x_K) d\mathbf{x} \\
    &= \int_\Omega \int_{\mathbb{R}^n} x_p \exp^{ik \cdot x_\alpha} p(x_0, \ldots, x_K, x_\alpha) d\mathbf{x} dx_\alpha \\
    &= \int_{\mathbb{R}^n} \left( \int_{\Omega} x_p \exp^{ik \cdot x_\alpha} p(x_0, \ldots, x_K|X_\alpha=x_\alpha) d\mathbf{x}\right) p(x_\alpha) dx_\alpha \\
    &= \int_{\mathbb{R}^n} \mathbb{E}[x_p|X_\alpha=x_\alpha] \exp(ik \cdot x_\alpha) p(x_\alpha) dx_\alpha \\
    &= \int_{\mathbb{R}^n} g_p(\alpha, x) e^{ik \cdot x} p(\alpha, x) dx \label{eq:10}\\
\end{align}
 Where $p(x_0, \ldots, x_K, x_\alpha)$ resolves as $p(x_0,\ldots, x_K) \delta(\sum_k \alpha_k x_k)$.

<p>Now, from \ref{eq:5} and \ref{eq:10}, we have,
\begin{align} 
i \alpha_0 k \mathbb{E}\left[e^{ik\cdot x(\alpha)}\right] &= \int_{\mathbb{R}^n} g_0(\alpha, x) e^{ik \cdot x} p(\alpha, x) dx \\
i \alpha_0 k \int e^{ik\cdot x} p(\alpha, x) dx &= \int_{\mathbb{R}^n} g_0(\alpha, x) e^{ik \cdot x} p(\alpha, x) dx \\
\end{align}
</p>

<p>
    Eq 10: $g_k$ is the unique minimizer of $L_k(\hat{g_k})$
    \begin{align}
    L_k(\hat{g_k}) &= \int_{\Delta^K} \mathbb{E}\left[|\hat{g}_k(\alpha, x_\alpha) - x_k|^2  \right] d\alpha  \\
    &= \int_{\Delta^K} \mathbb{E}\left[|\hat{g}_k(\alpha, x_\alpha)|^2 - 2 \hat{g}_k(\alpha, x_\alpha) \cdot x_k + |x_k|^2  \right] d\alpha  \\
    &= \int_{\Delta^K} \mathbb{E}\left[|\hat{g}_k(\alpha, x_\alpha)|^2- 2 \hat{g}_k(\alpha, x_\alpha) \cdot x_k \right] d\alpha + const
    \end{align}
</p>



<h2>Constructing trajectory</h2>
Let $\gamma(t) = (\gamma_0(t), \ldots, \gamma_K(t))$ denote a trajectory that moves from one vertex $e_i$ to another $e_j$. 

Since the vertices are orthogonal and $\xi(t;p) = \frac{\mathbf{e_j}^{2p}}{\sum_k \{{|e_j|^{2p}}\}^{(i)}} = \mathbf{e_j}$, $\xi(t; p)$ 
should move from $\mathbf{e_i}$ to $\mathbf{e_j}$ through the simplex. To compute the velocity $\dot{\xi}(t)$:
\begin{align} 
    \dot{\xi_j}(t) &= \frac{d }{dt} \left(\frac{\gamma_j(t)^{2p}}{\sum_k \gamma_k(t)^{2p}}\right) \\
    &= 2p \left(\dot{\gamma}_j(t) \frac{\gamma_j(t)^{2p-1}}{\sum_k \gamma_k(t)^{2p}}  - 
    \xi_j(t) \sum_k \frac{\gamma_k(t)^{2p-1} \dot{\gamma}_k(t)}{\sum_k \gamma_k(t)^{2p}}\right)
\end{align} 



<h2>Linear trajectory</h2>
<p>
    Let $\gamma(t) = (\gamma_1(t), \ldots, \gamma_K(t))$ represent a linear trajectory 
    from $\lambda_0$ at time $t_0$ to $\lambda_1$ at time $t_1$. This can be mapped into 
    $\xi(t)$ traversing through $\Delta^K$ as
</p>
\begin{align}
\xi_j(t) = \frac{\gamma_j(t)}{\sum_k \gamma_k(t)} 
\end{align}

<p>Then, the velocity $\dot{\xi}(t)$ becomes</p>
\begin{align} 
\dot{\xi}_i(t) &= \frac{d}{dt} \left( \frac{\gamma_i(t)}{\sum_k \gamma_k(t)}\right) \\
&= \dot{\gamma}_i(t) \frac{1}{\sum_k \gamma_k(t)}  - 
\xi_i(t) \sum_k\left(\dot{\gamma}_k(t) \frac{1}{\sum_k \gamma_k(t)}\right)
\end{align}

</body>
</html>